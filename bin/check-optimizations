#!/usr/bin/env php
<?php

/**
 * Alphavel Performance Optimization Checker
 * 
 * Verifica se todas as otimiza√ß√µes est√£o ativas
 */

echo "\nüîç Verificando Otimiza√ß√µes do Alphavel Framework\n";
echo str_repeat("=", 60) . "\n\n";

$checks = [];
$errors = [];
$warnings = [];

// 1. Verificar Swoole
echo "üì¶ Verificando Swoole...\n";
if (!extension_loaded('swoole')) {
    $errors[] = "‚ùå Swoole n√£o est√° instalado";
    echo "   ‚ùå Swoole N√ÉO encontrado\n";
} else {
    $version = phpversion('swoole');
    $checks[] = "‚úÖ Swoole instalado (vers√£o: $version)";
    echo "   ‚úÖ Swoole vers√£o $version\n";
}

// 2. Verificar Opcache
echo "\nüöÄ Verificando Opcache & JIT...\n";
if (!extension_loaded('opcache')) {
    $errors[] = "‚ùå Opcache n√£o est√° instalado";
    echo "   ‚ùå Opcache N√ÉO encontrado\n";
} else {
    $checks[] = "‚úÖ Opcache instalado";
    echo "   ‚úÖ Opcache instalado\n";
    
    // Verificar se est√° habilitado
    $enabled = ini_get('opcache.enable');
    if ($enabled) {
        $checks[] = "‚úÖ Opcache habilitado";
        echo "   ‚úÖ Opcache habilitado\n";
    } else {
        $errors[] = "‚ùå Opcache desabilitado";
        echo "   ‚ùå Opcache DESABILITADO\n";
    }
    
    // Verificar JIT
    $jit = ini_get('opcache.jit');
    
    if ($jit === 'disable' || $jit === 'off' || empty($jit)) {
        $checks[] = "‚úÖ JIT desabilitado (recomendado para I/O bound)";
        echo "   ‚úÖ JIT: desabilitado (recomendado para I/O bound)\n";
    } else {
        $warnings[] = "‚ö†Ô∏è  JIT habilitado ($jit). Para APIs I/O bound, 'disable' pode ser mais est√°vel.";
        echo "   ‚ö†Ô∏è  JIT: $jit (recomendado: disable)\n";
    }
    
    // Verificar outras configs importantes
    $memConsumption = ini_get('opcache.memory_consumption');
    $maxFiles = ini_get('opcache.max_accelerated_files');
    
    echo "   üìä Memory consumption: {$memConsumption}M\n";
    echo "   üìä Max accelerated files: $maxFiles\n";
    
    if ($memConsumption < 256) {
        $warnings[] = "‚ö†Ô∏è  opcache.memory_consumption baixo (recomendado: 256M)";
    }
    
    if ($maxFiles < 20000) {
        $warnings[] = "‚ö†Ô∏è  opcache.max_accelerated_files baixo (recomendado: 20000)";
    }
}

// 3. Verificar PDO
echo "\nüóÑÔ∏è  Verificando PDO...\n";
if (!extension_loaded('pdo')) {
    $errors[] = "‚ùå PDO n√£o est√° instalado";
    echo "   ‚ùå PDO N√ÉO encontrado\n";
} else {
    $checks[] = "‚úÖ PDO instalado";
    echo "   ‚úÖ PDO instalado\n";
    
    if (extension_loaded('pdo_mysql')) {
        $checks[] = "‚úÖ PDO MySQL instalado";
        echo "   ‚úÖ PDO MySQL instalado\n";
    } else {
        $errors[] = "‚ùå PDO MySQL n√£o est√° instalado";
        echo "   ‚ùå PDO MySQL N√ÉO encontrado\n";
    }
}

// 4. Verificar configura√ß√£o do Database
echo "\n‚öôÔ∏è  Verificando configura√ß√£o do Database...\n";

// Tentar encontrar DatabaseServiceProvider no vendor (instalado via composer)
$vendorPath = __DIR__ . '/../vendor/alphavel/database/DatabaseServiceProvider.php';
$localPath = __DIR__ . '/../../database/DatabaseServiceProvider.php'; // Para dev do framework

$dbServiceProvider = null;
if (file_exists($vendorPath)) {
    $dbServiceProvider = $vendorPath;
} elseif (file_exists($localPath)) {
    $dbServiceProvider = $localPath;
}

if ($dbServiceProvider) {
    $content = file_get_contents($dbServiceProvider);
    
    if (strpos($content, 'ATTR_EMULATE_PREPARES => false') !== false) {
        $checks[] = "‚úÖ Real Prepared Statements habilitado";
        echo "   ‚úÖ Real Prepared Statements: HABILITADO (permite Global Statement Cache)\n";
    } else if (strpos($content, 'ATTR_EMULATE_PREPARES => true') !== false) {
        $warnings[] = "‚ö†Ô∏è  Emulated Prepares habilitado (impede Global Statement Cache)";
        echo "   ‚ö†Ô∏è  Emulated Prepares: HABILITADO (recomendado: FALSE para usar cache de statements)\n";
    } else {
        $warnings[] = "‚ö†Ô∏è  ATTR_EMULATE_PREPARES n√£o configurado explicitamente";
        echo "   ‚ö†Ô∏è  ATTR_EMULATE_PREPARES: n√£o configurado\n";
    }
} else {
    echo "   ‚ÑπÔ∏è  Database package n√£o instalado (ok se n√£o usar DB)\n";
}

// 5. Verificar .env
echo "\nüìù Verificando .env...\n";

$envPath = __DIR__ . '/../.env';
if (file_exists($envPath)) {
    $envContent = file_get_contents($envPath);
    
    // Server Dispatch Mode
    if (preg_match('/SERVER_DISPATCH_MODE=(\d+)/', $envContent, $matches)) {
        $mode = $matches[1];
        if ($mode == 3) {
            $checks[] = "‚úÖ Dispatch Mode otimizado (Concurrent)";
            echo "   ‚úÖ SERVER_DISPATCH_MODE: 3 (Concurrent)\n";
        } else {
            $warnings[] = "‚ö†Ô∏è  SERVER_DISPATCH_MODE=$mode (recomendado: 3)";
            echo "   ‚ö†Ô∏è  SERVER_DISPATCH_MODE: $mode (recomendado: 3 para APIs stateless)\n";
        }
    } else {
        echo "   ‚ÑπÔ∏è  SERVER_DISPATCH_MODE n√£o configurado (usar√° default do config)\n";
    }
    
    // DB Pool Size
    if (preg_match('/DB_POOL_SIZE=(\d+)/', $envContent, $matches)) {
        $poolSize = $matches[1];
        $checks[] = "‚úÖ DB Pool Size: $poolSize";
        echo "   ‚úÖ DB_POOL_SIZE: $poolSize\n";
        
        if ($poolSize < 32) {
            $warnings[] = "‚ö†Ô∏è  DB_POOL_SIZE pequeno (recomendado: 64-128)";
        }
    } else {
        echo "   ‚ÑπÔ∏è  DB_POOL_SIZE n√£o configurado (usar√° default: 64)\n";
    }
    
    // Max Request
    if (preg_match('/SERVER_MAX_REQUEST=(\d+)/', $envContent, $matches)) {
        $maxReq = $matches[1];
        if ($maxReq == 0) {
            $checks[] = "‚úÖ Max Request ilimitado";
            echo "   ‚úÖ SERVER_MAX_REQUEST: 0 (unlimited)\n";
        } else {
            $warnings[] = "‚ö†Ô∏è  SERVER_MAX_REQUEST=$maxReq (recomendado: 0)";
            echo "   ‚ö†Ô∏è  SERVER_MAX_REQUEST: $maxReq (recomendado: 0)\n";
        }
    }
} else {
    $warnings[] = "‚ö†Ô∏è  Arquivo .env n√£o encontrado";
    echo "   ‚ö†Ô∏è  .env n√£o encontrado\n";
}

// 6. Verificar vers√£o do PHP
echo "\nüêò Verificando PHP...\n";
$phpVersion = phpversion();
echo "   ‚úÖ PHP vers√£o: $phpVersion\n";

if (version_compare($phpVersion, '8.2.0', '>=')) {
    $checks[] = "‚úÖ PHP 8.2+ (suporte completo a JIT)";
} else if (version_compare($phpVersion, '8.0.0', '>=')) {
    $warnings[] = "‚ö†Ô∏è  PHP < 8.2 (JIT melhorado em 8.2+)";
} else {
    $errors[] = "‚ùå PHP < 8.0 (sem suporte a JIT)";
}

// Resumo
echo "\n" . str_repeat("=", 60) . "\n";
echo "üìä RESUMO\n";
echo str_repeat("=", 60) . "\n\n";

if (count($checks) > 0) {
    echo "‚úÖ Verifica√ß√µes bem-sucedidas: " . count($checks) . "\n";
}

if (count($warnings) > 0) {
    echo "\n‚ö†Ô∏è  Avisos: " . count($warnings) . "\n";
    foreach ($warnings as $warning) {
        echo "   $warning\n";
    }
}

if (count($errors) > 0) {
    echo "\n‚ùå Erros: " . count($errors) . "\n";
    foreach ($errors as $error) {
        echo "   $error\n";
    }
}

// Status final
echo "\n" . str_repeat("=", 60) . "\n";

if (count($errors) === 0) {
    if (count($warnings) === 0) {
        echo "üéâ PERFEITO! Todas as otimiza√ß√µes est√£o ativas.\n";
        echo "   Performance esperada: 16k+ req/s em leitura\n";
        exit(0);
    } else {
        echo "‚úÖ BOM! Sistema funcional com algumas otimiza√ß√µes pendentes.\n";
        echo "   Aplique os avisos acima para m√°xima performance.\n";
        exit(0);
    }
} else {
    echo "‚ùå PROBLEMAS DETECTADOS! Corrija os erros acima.\n";
    exit(1);
}
