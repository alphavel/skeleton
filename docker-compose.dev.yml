version: '3.8'

services:
  app:
    image: php:8.2-cli
    container_name: alphavel-dev
    working_dir: /app
    ports:
      - "${APP_PORT:-9999}:9999"
    volumes:
      - ./:/app
    environment:
      - APP_ENV=${APP_ENV:-local}
      - APP_DEBUG=${APP_DEBUG:-true}
      - DB_HOST=db
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE:-alphavel}
      - DB_USERNAME=${DB_USERNAME:-alphavel}
      - DB_PASSWORD=${DB_PASSWORD:-alphavel}
    networks:
      - alphavel-dev
    depends_on:
      db:
        condition: service_healthy
    entrypoint: /bin/bash
    command:
      - -c
      - |
        set -e
        echo "üîß Configurando ambiente de desenvolvimento..."
        
        # Instalar depend√™ncias do sistema
        apt-get update -qq
        apt-get install -y -qq curl git unzip libssl-dev libcurl4-openssl-dev libbrotli-dev autoconf g++ make zip libzip-dev > /dev/null 2>&1
        
        # Instalar extens√µes PHP necess√°rias
        docker-php-ext-install -j$$(nproc) zip > /dev/null 2>&1 || true
        
        # Instalar Swoole
        if ! php -m | grep -q swoole; then
          echo "üì¶ Instalando extens√£o Swoole..."
          pecl install -q swoole > /dev/null 2>&1
          docker-php-ext-enable swoole
          echo "‚úÖ Swoole instalado!"
        else
          echo "‚úÖ Swoole j√° est√° instalado!"
        fi
        
        # Instalar Composer
        if [ ! -f /usr/local/bin/composer ]; then
          echo "üì¶ Instalando Composer..."
          curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer > /dev/null 2>&1
          echo "‚úÖ Composer instalado!"
        fi
        
        # Instalar depend√™ncias do projeto
        if [ ! -d vendor ]; then
          echo "üì¶ Instalando depend√™ncias do projeto..."
          composer install --no-interaction --prefer-dist --optimize-autoloader
          echo "‚úÖ Depend√™ncias instaladas!"
        else
          echo "‚úÖ Depend√™ncias j√° est√£o instaladas!"
        fi
        
        # Criar estrutura de diret√≥rios
        echo "üìÅ Criando estrutura de diret√≥rios..."
        mkdir -p storage/framework storage/logs storage/cache bootstrap/cache
        chmod -R 777 storage bootstrap/cache
        
        # Criar arquivo facades.php se n√£o existir
        if [ ! -f storage/framework/facades.php ]; then
          echo '<?php' > storage/framework/facades.php
        fi
        
        # Copiar .env se n√£o existir
        if [ ! -f .env ] && [ -f .env.example ]; then
          cp .env.example .env
          echo "‚úÖ Arquivo .env criado!"
        fi
        
        echo ""
        echo "üöÄ Iniciando servidor Swoole na porta 9999..."
        echo "üåê Acesse: http://localhost:9999"
        echo ""
        
        php public/index.php
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9999/ || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 90s

  db:
    image: mysql:8.0
    container_name: alphavel-dev-db
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-alphavel}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root}
      MYSQL_PASSWORD: ${DB_PASSWORD:-alphavel}
      MYSQL_USER: ${DB_USERNAME:-alphavel}
    ports:
      - "${DB_PORT:-3307}:3306"
    volumes:
      - dbdata-dev:/var/lib/mysql
    networks:
      - alphavel-dev
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD:-root}"]
      timeout: 20s
      retries: 10
      interval: 10s

networks:
  alphavel-dev:
    driver: bridge

volumes:
  dbdata-dev:
    driver: local
