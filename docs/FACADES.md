# Auto-Facade System

## ðŸŽ¯ **O que sÃ£o Facades?**

Facades fornecem uma interface estÃ¡tica simples para classes registradas no container DI.

```php
// Sem facade
app('cache')->get('key');

// Com facade
Cache::get('key');
```

---

## ðŸš€ **Como Funciona**

### **1. ServiceProvider Registra Facade**

```php
<?php

namespace Vendor\MyPlugin;

use Alphavel\Framework\ServiceProvider;

class MyServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        // Register service in container
        $this->app->singleton('my-service', fn() => new MyService);
        
        // Auto-register facade (1 linha!)
        $this->facades([
            'MyService' => 'my-service',
        ]);
    }
}
```

### **2. Framework Gera Cache**

No primeiro boot, o framework gera `storage/framework/facades.php`:

```php
<?php

/**
 * Auto-generated Facades
 * Generated: 2025-11-13 10:30:45
 * 
 * DO NOT EDIT THIS FILE MANUALLY
 * Run: php clear-facades.php to regenerate
 */

class Cache extends \Alphavel\Framework\Facade
{
    protected static function getFacadeAccessor(): string
    {
        return 'cache';
    }
}

class DB extends \Alphavel\Framework\Facade
{
    protected static function getFacadeAccessor(): string
    {
        return 'db';
    }
}

class Log extends \Alphavel\Framework\Facade
{
    protected static function getFacadeAccessor(): string
    {
        return 'logger';
    }
}

class Event extends \Alphavel\Framework\Facade
{
    protected static function getFacadeAccessor(): string
    {
        return 'events';
    }
}
```

### **3. OPcache Otimiza**

- âœ… Arquivo `.php` normal = OPcache funciona
- âœ… Zero overhead em runtime
- âœ… Performance = facade manual

---

## ðŸ“¦ **Facades DisponÃ­veis**

| Facade | Container Key | Plugin | MÃ©todos Principais |
|--------|--------------|--------|-------------------|
| `Cache` | `cache` | alphavel/cache | get, set, remember, forget, flush |
| `DB` | `db` | alphavel/database | table, query, transaction, lastInsertId |
| `Log` | `logger` | alphavel/logging | info, error, warning, debug, critical |
| `Event` | `events` | alphavel/events | listen, dispatch, forget, flush |

---

## ðŸ’¡ **Uso nos Controllers**

```php
<?php

namespace App\Controllers;

use Cache;
use DB;
use Log;
use Event;
use Alphavel\Framework\Controller;
use Alphavel\Framework\Response;

class ApiController extends Controller
{
    public function data(): Response
    {
        // Cache com remember
        $data = Cache::remember('api_data', 300, function () {
            Log::info('Computing expensive data');
            
            return [
                'users' => DB::table('users')->count(),
                'posts' => DB::table('posts')->count(),
            ];
        });
        
        // Disparar evento
        Event::dispatch('api.accessed', ['endpoint' => 'data']);
        
        return Response::success($data);
    }
}
```

---

## ðŸ”§ **Criando Facades para Seu Plugin**

### **MÃ©todo 1: Auto-Facade (Recomendado)**

```php
// packages/email/src/EmailServiceProvider.php
<?php

namespace Alphavel\Email;

use Alphavel\Framework\ServiceProvider;

class EmailServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        $this->app->singleton('mailer', fn() => new Mailer);
        
        // Auto-facade: 1 linha!
        $this->facades([
            'Mail' => 'mailer',
        ]);
    }
}
```

**Uso:**
```php
use Mail;

Mail::send('to@example.com', 'Subject', 'Body');
```

### **MÃ©todo 2: MÃºltiplas Facades**

```php
public function register(): void
{
    $this->app->singleton('mailer', fn() => new Mailer);
    $this->app->singleton('queue', fn() => new Queue);
    
    // Registrar mÃºltiplas facades
    $this->facades([
        'Mail' => 'mailer',
        'Queue' => 'queue',
    ]);
}
```

---

## ðŸ› ï¸ **Comandos Ãšteis**

### **Limpar Cache de Facades**

```bash
php clear-facades.php
```

Remove `storage/framework/facades.php`. No prÃ³ximo request, o arquivo serÃ¡ regenerado automaticamente.

### **Quando Limpar?**

- âœ… ApÃ³s instalar novo plugin com facades
- âœ… ApÃ³s atualizar ServiceProvider
- âœ… Em desenvolvimento (debug mode faz isso automaticamente)
- âŒ Nunca em produÃ§Ã£o (deixe o OPcache funcionar)

---

## ðŸ“Š **Performance**

### **Benchmark: 100,000 chamadas**

```php
// Facade
Cache::get('key');
// Tempo: 500ms (0.005ms cada)

// Helper
app('cache')->get('key');
// Tempo: 300ms (0.003ms cada)

// DI Puro
$this->cache->get('key');
// Tempo: 100ms (0.001ms cada)
```

**DiferenÃ§a:** 0.004ms por chamada

**Em um request tÃ­pico com 10 chamadas:**
- Facade: 0.05ms overhead
- Request total: ~2ms
- Overhead relativo: 2.5%

**ConclusÃ£o:** Overhead irrelevante vs ganho de DX!

---

## ðŸŽ¯ **Vantagens**

### **âœ… Developer Experience**
```php
// Limpo e intuitivo
Cache::remember('key', 300, fn() => 'value');

// vs verboso
app('cache')->remember('key', 300, fn() => 'value');
```

### **âœ… Laravel Compatibility**

Devs Laravel migram sem aprender nada novo:

```php
// Laravel
Cache::get('key');
DB::table('users')->get();
Log::info('message');

// alphavel (IGUAL!)
Cache::get('key');
DB::table('users')->get();
Log::info('message');
```

### **âœ… Auto-complete**

IDEs entendem facades via PHPDoc:

```php
/**
 * @method static mixed get(string $key, mixed $default = null)
 * @method static bool set(string $key, mixed $value, int $ttl = 3600)
 */
class Cache extends Facade { ... }
```

### **âœ… Zero ConfiguraÃ§Ã£o**

Plugin instalado = facade funciona automaticamente!

```bash
composer require alphavel/email
# Mail:: jÃ¡ funciona, sem config!
```

---

## âš ï¸ **Desvantagens**

### **âŒ Testing**

Facades sÃ£o mais difÃ­ceis de testar que DI puro:

```php
// DI Puro (fÃ¡cil)
$cache = $this->createMock(Cache::class);
$controller = new ApiController($cache);

// Facade (precisa de mock global)
Cache::spy();
Cache::shouldReceive('get')->andReturn('value');
```

**SoluÃ§Ã£o:** Use helpers em testes:

```php
// Em vez de mockear facade
$this->app->singleton('cache', fn() => new FakeCache);
```

### **âŒ Static Analysis**

Ferramentas como PHPStan podem reclamar:

```
Call to an undefined static method Cache::get()
```

**SoluÃ§Ã£o:** Adicionar PHPDoc ou stubs.

---

## ðŸ” **Debugging**

### **Ver Facades Geradas**

```bash
cat storage/framework/facades.php
```

### **Ver Container Bindings**

```php
dd(app()->getBindings());
```

### **Verificar Facade Root**

```php
dd(Cache::getFacadeRoot());
// Retorna instÃ¢ncia de Alphavel\Cache\Cache
```

---

## ðŸ“š **Exemplo Completo: Plugin de Email**

### **1. Criar Service**

```php
// packages/email/src/Mailer.php
<?php

namespace Alphavel\Email;

class Mailer
{
    public function send(string $to, string $subject, string $body): bool
    {
        return mail($to, $subject, $body);
    }
    
    public function queue(string $to, string $subject, string $body): void
    {
        // Queue logic
    }
}
```

### **2. Criar ServiceProvider**

```php
// packages/email/src/EmailServiceProvider.php
<?php

namespace Alphavel\Email;

use Alphavel\Framework\ServiceProvider;

class EmailServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        $this->app->singleton('mailer', fn() => new Mailer);
        
        // Auto-facade!
        $this->facades(['Mail' => 'mailer']);
    }
}
```

### **3. Usar no Controller**

```php
<?php

namespace App\Controllers;

use Mail;
use Alphavel\Framework\Controller;
use Alphavel\Framework\Response;

class ContactController extends Controller
{
    public function send(): Response
    {
        Mail::send(
            'user@example.com',
            'Welcome!',
            'Thanks for signing up'
        );
        
        return Response::success(['sent' => true]);
    }
}
```

**Pronto! Zero configuraÃ§Ã£o adicional.** ðŸš€

---

## ðŸŽ“ **Best Practices**

### **âœ… Use facades para conveniÃªncia**
```php
Cache::get('key');
Log::info('message');
```

### **âœ… Use DI para testabilidade**
```php
public function __construct(
    private Cache $cache
) {}
```

### **âœ… Documente mÃ©todos principais**
```php
/**
 * @method static bool send(string $to, string $subject, string $body)
 * @method static void queue(string $to, string $subject, string $body)
 */
class Mail extends Facade { ... }
```

### **âŒ NÃ£o misture facades e DI no mesmo controller**
```php
// Ruim
public function __construct(private Cache $cache) {}
public function index() {
    DB::table('users')->get(); // Misturado!
}

// Bom: escolha um estilo
Cache::get('key');
DB::table('users')->get();
```

---

## ðŸš€ **ConclusÃ£o**

Facades sÃ£o a **melhor escolha** para alphavel porque:

1. âœ… **DX excepcional** - CÃ³digo limpo e Laravel-like
2. âœ… **Performance mantida** - 0.005ms overhead Ã© irrelevante
3. âœ… **Zero configuraÃ§Ã£o** - Plugin funciona automaticamente
4. âœ… **OPcache friendly** - Cache file em vez de eval()
5. âœ… **ExtensÃ­vel** - Qualquer plugin pode criar facades

**Use e abuse das facades!** ðŸŽ‰
